<div class="container mt-4">

    <app-mobile-header-with-back-button  [zIndex]="100003" [backUrl]="'/business/select-plan'"  [heading]="'Complete Payment'" ></app-mobile-header-with-back-button>


    <div class="row mb-1">

        <h2 class="h2-responsive font-weight-bold d-none d-md-block">Complete Payment</h2>

        <div class="col-md-12" *ngIf="dataProgress === true || progress === true">
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        </div>


    </div>

    <div class="row">
        <div class="col-12 d-flex pt-1 pb-2 justify-content-center">

            <img src="https://dzo92l8g6opo1.cloudfront.net/58d20f92-18c2-4d87-9c06-7f176be32ff5/logo.svg" style="width: 200px;">

        </div>
<!--        <div class="col-12 d-flex py-2 justify-content-center">-->

<!--            <div class="alert alert-dark">-->
<!--                {{"We do not save your card data, your credit card data is secured with and processed by "}}-->
<!--                <a href="https://pixelpay.com/" target="_blank">PixelPay</a>-->
<!--            </div>-->
<!--        </div>-->

        <div class="col-12">
            <app-my-stepper [steps]="steps" [activeStep]="currentStep"></app-my-stepper>

        </div>


        <ng-container *ngIf="currentStep === 0">
            <div class="col-12 my-3 px-2" *ngIf="plan">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="w-100 d-flex flex-column gap-2">
                            <div class="w-100 d-flex justify-content-between align-items-center">
                                <p class="mb-0">{{"Subscription plan" | translate}}</p>
                                <p class="mb-0">
                                    {{plan.name}}
                                </p>
                            </div>



                            <div class="w-100 d-flex justify-content-between align-items-center">
                                <p class="mb-0">{{"Monthly Price" | translate}}</p>
                                <p class="mb-0 text-success">
                                    {{plan.price}} {{"HNL" | translate}}
                                </p>


                            </div>

                            <div class="w-100 mt-3 mb-2" *ngIf="!hasTrial">
                                <h3 class="mb-0">{{ "Select Duration / Payment Frequency" | translate }}</h3>

                                <mat-form-field style="padding-top: 0 !important;margin-top: 0 !important;">
                                    <mat-select [(ngModel)]="payment_frequency"
                                                [ngModelOptions]="{standalone: true}">
                                        <mat-option [value]="1">{{ "Monthly ( 1 Month )" | translate }}</mat-option>
                                        <mat-option *ngIf="!hasTrial" [value]="12">{{ "Annual ( 12 Months )" | translate }}</mat-option>
                                    </mat-select>
                                </mat-form-field>

                                <p class="text-info">
                                    <small *ngIf="payment_frequency === 1">
                                        {{"You will be billed monthly" | translate}}
                                    </small>
                                    <small *ngIf="payment_frequency === 12">
                                        {{"You will be billed annually" | translate}}
                                    </small>
                                </p>

<!--                                <div class="form-group">-->
<!--                                    <label [matTooltip]="'Your subscription will end after this duration and you will be asked to pay to renew your subscription'"></label>-->

<!--                                    -->
<!--                                    <select class="form-control" >-->
<!--                                        <option value="1"></option>-->
<!--                                    </select>-->
<!--                                </div>-->

                            </div>


<!--                            <div class="w-100 d-flex justify-content-between align-items-center">-->
<!--                                <p class="mb-0">{{"Duration" | translate}}</p>-->
<!--                                <p class="mb-0 text-success">-->
<!--                                    {{plan.duration}} {{"months" | translate}}-->
<!--                                </p>-->
<!--                            </div>-->


                            <ng-container *ngIf="!hasTrial">
                                <div class="w-100 d-flex justify-content-between align-items-center">
                                    <p class="mb-0">{{"Amount to Pay" | translate}}</p>
                                    <p class="mb-0 fw-bold text-success">
                                        {{plan.price * payment_frequency}} {{"HNL" | translate}}
                                    </p>
                                </div>
                            </ng-container>
                            <ng-container *ngIf="hasTrial">
                                <div class="w-100 d-flex justify-content-between align-items-center">
                                    <p class="mb-0">{{"Total" | translate}}</p>
                                    <p class="mb-0 fw-bold text-success">
                                        {{plan.price * payment_frequency}} {{"HNL" | translate}}
                                    </p>
                                </div>
                                <div class="w-100 d-flex justify-content-between align-items-center">
                                    <p class="mb-0">{{"Payable in free trial" | translate}}</p>
                                    <p class="mb-0 fw-bold text-success">
                                        {{0}} {{"HNL" | translate}}
                                    </p>
                                </div>
                            </ng-container>


                        </div>

                    </div>
                </div>

                <form class="mt-4" [formGroup]="formSettings">
                    <mat-checkbox [(ngModel)]="auto_renewal" [ngModelOptions]="{standalone: true}" [checked]="auto_renewal">{{"Enable Auto Renewal" | translate}}</mat-checkbox>

                    <div class="alert alert-dark mt-2">
                        {{"If you disable auto renewal, your subscription will be cancelled after expiration date if you don't renew manually" | translate}}
                    </div>

                    <div class="alert alert-danger">
                        {{"You can cancel subscription anytime" | translate}}
                    </div>


                    <div class="w-100">
                        <button (click)="currentStep = 1" class="btn btn-theme-dark btn-block my-3">
                            <ng-container *ngIf="!hasTrial">{{"Proceed to Payment" | translate}}</ng-container>
                            <ng-container *ngIf="hasTrial">{{"Start Free Trial" | translate}}</ng-container>

                        </button>
                    </div>


                </form>

            </div>
        </ng-container>

        <ng-container *ngIf="currentStep === 1">

            <ng-container *ngIf="selectedPaymentMethod !== 'new_card' && selectedPaymentMethod !== 'bank_transfer'">

                <div class="w-100 mt-4 mb-3 d-flex justify-content-between align-items-center">
                    <h4 class="fw-bold mb-0">{{ "Select a Payment Method" }}</h4>

                    <a (click)="currentStep = 0" class="text-decoration-underline">
                        {{"Back" | translate}}
                    </a>

                </div>

                <!-- Bank transfer -->
                <div class="col-12 dashboard-action-widget mb-3">
                    <div class="card" (click)="onPaymentMethodSelect('bank_transfer')">
                        <div class="card-body py-3">
                            <div class="col-12 d-flex justify-content-start align-items-center">
                                <h4 class="mb-0 d-flex align-items-center gap-2">
                                <span class="material-symbols-outlined">
                                    account_balance
                                </span>
                                    {{ "Bank Transfer" | translate }}</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- End Option Bank Transfer -->

                <div class="col-12 dashboard-action-widget mb-3">
                    <div class="card" (click)="onPaymentMethodSelect('new_card')">
                        <div class="card-body py-3">
                            <div class="col-12 d-flex justify-content-start align-items-center">
                                <h4 class="mb-0 d-flex align-items-center gap-2">
                                <span class="material-symbols-outlined">
                                    credit_card
                                </span>
                                    {{ "Use a new card" | translate }}</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 dashboard-action-widget mb-3" *ngFor="let card of paymentMethods">
                    <div class="card" >
                        <div class="card-body py-3">
                            <div class="col-12 d-flex justify-content-between align-items-center">

                                <div class="d-flex gap-3">
                                    <div>
                                        <img src="assets/img/brands/{{card.brand}}.png" style="width: 40px">
                                    </div>

                                    <div class="d-flex flex-column">
                                        <p class="mb-0">{{card.mask}}</p>
                                        <span class="text-muted">{{ card.exp_month }} / {{ card.exp_year }}</span>
                                    </div>

                                </div>


                                <div>

                                    <ng-container *ngIf="card.token === formSubscribe.controls['card_token'].value">
                                        <div class="d-flex gap-1 align-items-center text-success">
<span class="material-symbols-outlined text-success">
check_circle
</span>
                                            <span class="text-success">{{"Selected" | translate}}</span>
                                        </div>
                                    </ng-container>
                                    <ng-container *ngIf="card.token !== formSubscribe.controls['card_token'].value">
                                        <button (click)="onPaymentMethodSelect(card)" class="btn btn-theme-dark btn-sm">
                                            {{ "Select" | translate }}
                                        </button>
                                    </ng-container>



                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-12">


                    <div class="form-group d-flex justify-content-end align-items-center">


                        <button (click)="confirmPaymentByToken()"  class="btn btn-theme-dark btn-block">
                            <ng-container *ngIf="!hasTrial">
                                {{ "Confirm Pay" | translate }} {{ (plan.price * payment_frequency).toFixed(2) }} HNL
                            </ng-container>
                            <ng-container *ngIf="hasTrial">
                                {{"Start Free Trial" | translate}}
                            </ng-container>
                        </button>

                    </div>


                </div>



            </ng-container>

            <ng-container *ngIf="selectedPaymentMethod === 'new_card'">

                <form id="promotion-form-mobile" class="w-100 mt-4 mb-4" [formGroup]="formCard">


                    <div class="row">

                        <div class="col-12 d-flex justify-content-end mb-2">
                            <a (click)="onPaymentMethodSelect(null)" class="text-decoration-underline">{{"Change Payment Method" | translate}}</a>
                        </div>

                        <div class="col-md-12">

                            <ng-container *ngIf="formCard.controls['card_number'].errors && addCardErrors.card_number">
                                <mat-error *ngFor="let error of addCardErrors.card_number">{{error}}</mat-error>
                            </ng-container>
                            <mat-form-field class="example-full-width"  appearance="outline">
                                <mat-label>{{"Card Number" | translate}}</mat-label>
                                <input formControlName="card_number"  matInput type="number" >

                                <img src="assets/img/brands/master.png" style="width: 40px" matSuffix>
                            </mat-form-field>


                        </div>
                    </div>
                    <div class="row">
                        <ng-container *ngIf="formCard.controls['card_exp'].errors && addCardErrors.card_expire">
                            <div class="col-12">
                                <mat-error *ngFor="let error of addCardErrors.card_expire">{{error}}</mat-error>
                            </div>
                        </ng-container>
                        <ng-container *ngIf="formCard.controls['card_cvv'].errors && addCardErrors.card_cvv">
                            <div class="col-12">
                                <mat-error *ngFor="let error of addCardErrors.card_cvv">{{error}}</mat-error>
                            </div>
                        </ng-container>
                        <div class="col-6">

<!--                            <ng-container *ngIf="formCard.controls['card_exp'].errors && addCardErrors.expire_year">-->
<!--                                <mat-error *ngFor="let error of addCardErrors.expire_year">{{error}}</mat-error>-->
<!--                            </ng-container>-->
                            <mat-form-field class="example-full-width"  appearance="outline">
                                <mat-label>{{"Expiry" | translate}}</mat-label>
                                <input formControlName="card_exp" placeholder="MM/YY"  matInput type="text" >

                            </mat-form-field>

                        </div>

                        <div class="col-6">

                            <mat-form-field class="example-full-width"  appearance="outline">
                                <mat-label>{{"CVC" | translate}}</mat-label>
                                <input formControlName="card_cvv"  matInput type="text" >

                            </mat-form-field>

                        </div>
                    </div>

                    <div class="row">

                        <div class="col-md-12">
                            <ng-container *ngIf="formCard.controls['holder_name'].errors && addCardErrors.card_holder">
                                <mat-error *ngFor="let error of addCardErrors.card_holder">{{error}}</mat-error>
                            </ng-container>
                            <mat-form-field class="example-full-width"  appearance="outline">
                                <mat-label>{{"Card Holder Name" | translate}}</mat-label>
                                <input formControlName="holder_name"  matInput type="text" >

                            </mat-form-field>

                        </div>
                        <ng-container *ngIf="formCard.controls['country'].errors && addCardErrors.billing_country">
                            <div class="col-12">
                                <mat-error *ngFor="let error of addCardErrors.billing_country">{{error}}</mat-error>
                            </div>
                        </ng-container>
                        <ng-container *ngIf="formCard.controls['state'].errors && addCardErrors.billing_state">
                            <div class="col-12">
                                <mat-error *ngFor="let error of addCardErrors.billing_state">{{error}}</mat-error>
                            </div>
                        </ng-container>


                        <div class="col-6">

                            <mat-form-field appearance="outline">
                                <mat-label>{{'Country' | translate}}</mat-label>

                                <select matNativeControl formControlName="country" (change)="filterStates()">
                                    <option value="" selected></option>
                                    <option *ngFor="let country of countries" [value]="country.iso2">
                                        {{country.name}}
                                    </option>
                                </select>

                            </mat-form-field>

<!--                            <mat-form-field class="example-full-width" appearance="outline">-->
<!--                                <mat-label>{{ "Country" | translate }}</mat-label>-->
<!--                                <input formControlName="country" matInput type="text" placeholder="Ex: HN">-->

<!--                            </mat-form-field>-->

                        </div>
                        <div class="col-6">

                            <mat-form-field appearance="outline">
                                <mat-label>{{'State' | translate}}</mat-label>

                                <select matNativeControl formControlName="state">
                                    <option value="" selected></option>
                                    <option *ngFor="let state of filteredStates" value="{{state.country_code}}-{{state.iso2}}">
                                        {{state.name}}
                                    </option>
                                </select>

                            </mat-form-field>

<!--                            <mat-form-field class="example-full-width"  appearance="outline">-->
<!--                                <mat-label>{{"State" | translate}}</mat-label>-->
<!--                                <input formControlName="state"  matInput type="text" placeholder="Ex: HN-CR" >-->

<!--                            </mat-form-field>-->

                        </div>


                        <div class="col-md-12">
                            <ng-container *ngIf="formCard.controls['city'].errors && addCardErrors.billing_city">
                                <mat-error *ngFor="let error of addCardErrors.billing_city">{{error}}</mat-error>
                            </ng-container>
                            <mat-form-field class="example-full-width"  appearance="outline">
                                <mat-label>{{"City" | translate}}</mat-label>
                                <input formControlName="city"  matInput type="text" placeholder="Ex: San Pedro Sula" >

                            </mat-form-field>

                        </div>
                        <div class="col-md-12">
                            <ng-container *ngIf="formCard.controls['address'].errors && addCardErrors.billing_address">
                                <mat-error *ngFor="let error of addCardErrors.billing_address">{{error}}</mat-error>
                            </ng-container>
                            <mat-form-field class="example-full-width"  appearance="outline">
                                <mat-label>{{"Address" | translate}}</mat-label>
                                <input formControlName="address"  matInput type="text" >

                            </mat-form-field>

                        </div>

                        <div class="col-md-12">
                            <ng-container *ngIf="formCard.controls['phone'].errors && addCardErrors.billing_phone">
                                <mat-error *ngFor="let error of addCardErrors.billing_phone">{{error}}</mat-error>
                            </ng-container>
                            <mat-form-field class="example-full-width" appearance="outline">
                                <mat-label>{{ "Phone" | translate }}</mat-label>
                                <input formControlName="phone" matInput type="text">

                            </mat-form-field>

                        </div>


                    </div>
                    
                    <div class="row">

                      
                        <div class="col-md-12">

                      
                            <mat-checkbox class="my-2" *ngIf="!hasTrial"  formControlName="allow_tokenization">
                                    {{"Save this card for future usage" | translate}}
                            </mat-checkbox>


                        </div>




                        <div class="col-md-12">


                            <div class="form-group d-flex justify-content-end align-items-center">

                                <button (click)="confirmPaymentByCard()"  class="btn btn-theme-dark btn-block">
                                    <ng-container *ngIf="!hasTrial">
                                        {{ "Confirm Pay" | translate}} {{(plan.price * payment_frequency).toFixed(2)}} HNL
                                    </ng-container>
                                    <ng-container *ngIf="hasTrial">
                                        {{"Start Free Trial" | translate}}
                                    </ng-container>
                                </button>

                            </div>


                        </div>

                    </div>

                </form>

            </ng-container>

        </ng-container>

        <ng-container *ngIf="currentStep === 2">
            <div class="col-12 my-3" *ngIf="my_plan">
                <div class="card">
                    <div class="card-body px-4">



                            <div class="w-100 my-2 d-flex justify-content-center align-items-center flex-column">

                                <span class="material-symbols-outlined text-success" style="font-size: 45px;">
check_circle
</span>

                                <h4 class="text-success">{{"Subscribed successfully" | translate}}</h4>

                            </div>


                            <p>Plan : {{my_plan.plan.name}}</p>
                            <p>Started at : {{my_plan.started_at | date}}</p>
                            <p>End Date : {{my_plan.expires_at | date}}</p>
                            <p>Status : {{my_plan.subscription_status}}</p>
                            <p>Next Billing Date : {{my_plan.expires_at | date}}</p>

                            <div class="alert alert-dark my-3">
                                {{"We will send you notification before 1 week of expiration" | translate}}
                            </div>



                    </div>
                </div>


            </div>

        </ng-container>

        <!-- If Bank Transfer is selected as payment method -->
        <ng-container *ngIf="offlinePaymentEnabled && selectedPaymentMethod === 'bank_transfer' && plan !== undefined && bank !== undefined">

            <div class="col-12  mt-4 d-flex justify-content-end mb-2">
                <a (click)="onPaymentMethodSelect(null)" class="text-decoration-underline">{{"Change Payment Method" | translate}}</a>
            </div>

            <div class="col-md-12 mt-2">

                    <div class="alert alert-dark">

                        {{"Our team will review your information once you submit , the selected membership plan will be assigned to your account as soon as your payment information is approved" | translate}}
                    </div>

                </div>
            <div class="col-md-5">

                    <div class="card">

                        <div class="card-header py-2">
                            <p class="fw-bold mb-0">Bank Information to transfer funds</p>
                        </div>

                        <div class="card-body py-2">

                            <p>Bank Name : {{bank.bank_name}}</p>
                            <p>Branch : {{bank.branch}}</p>
                            <p>Account Name : {{bank.account_name}}</p>
                            <p>Account Number : {{bank.account_no}}</p>
                            <p>Routing : {{bank.routing}}</p>

                        </div>
                        <div class="card-body py-2">
                            <p class="fw-bold mb-0">Reference</p>


                        </div>
                        <div class="card-body py-2">

                            <p>Make payment to the Bank. User ID : <span class="font-weight-bold">{{authService.getUserID()}}</span></p>

                            <p>
                                Once you have transferred your funds , enter your transfer details so we can identify your payment and finish the approval process faster. Please take a receipt or reference number from your bank after completing payment.
                            </p>

                        </div>

                    </div>



                </div>
            <div class="col-md-7 mb-5 mb-md-0">
                    <div class="card mt-3 mt-md-0 py-2">

                        <div class="card-header">
                            <p class="fw-bold mb-0">Payment Details</p>
                        </div>



                        <div class="card-body px-3">


                            <form (submit)="saveBankPayment()" [formGroup]="formPayment">

                                <div class="col-md-12">

                                    <mat-form-field  appearance="outline">
                                        <mat-error></mat-error>
                                        <mat-label>Bank account name you are paying from:</mat-label>

                                        <input matInput type="text" formControlName="bank_name" placeholder="Enter bank name"  >
                                    </mat-form-field>

                                </div>
                                <div class="col-md-12">

                                    <mat-form-field  appearance="outline">
                                        <mat-error></mat-error>
                                        <mat-label>Date of payment</mat-label>

                                        <input matInput type="date" formControlName="payment_date" placeholder=""  >
                                    </mat-form-field>

                                </div>
                                <div class="col-md-12">

                                    <mat-form-field  appearance="outline">
                                        <mat-error></mat-error>
                                        <mat-label>Payment reference (receipt or reference number):
                                        </mat-label>

                                        <input matInput type="text" formControlName="reference_number" placeholder=""  >
                                    </mat-form-field>

                                </div>

                                <div class="col-md-12">


                                    <h3> Selected Plan : {{plan.name}} </h3>

                                </div>
                                <div class="col-md-12">


                                    <h3> Price / month : ${{plan.price}} USD</h3>

                                </div>
<!--                                <div class="col-md-12">-->

<!--                                    <mat-form-field appearance="outline">-->
<!--                                        <mat-label>Select Billing Period</mat-label>-->
<!--                                        <mat-error></mat-error>-->
<!--                                        <mat-select formControlName="duration">-->
<!--                                            <mat-select-trigger>-->
<!--                                                {{formPayment.controls.duration.value}} Month(s)-->
<!--                                            </mat-select-trigger>-->
<!--                                            <mat-option value="1">1 Month</mat-option>-->
<!--                                            <mat-option value="12">12 Months</mat-option>-->

<!--                                        </mat-select>-->
<!--                                    </mat-form-field>-->



<!--                                </div>-->
                                <div class="col-md-12">


                                    <h3> Subscription duration : {{formPayment.controls.duration.value}} Month(s)</h3>

                                </div>
                                <div class="col-md-12">


                                    <h3> Total Payable : ${{plan.price * formPayment.controls.duration.value}} USD</h3>

                                </div>



                                <div class="col-md-12">



                                    <button type="submit" class="btn btn-theme-dark col-12">
                                        <i class="fa fa-check"></i>&nbsp; {{ "Confirm Payment" | translate }}
                                    </button>


                                </div>



                            </form>

                        </div>

                    </div>

                </div>

        </ng-container>
        <!-- End bank transfer -->

    </div>


</div>
<app-progress-bar *ngIf="progress"></app-progress-bar>
